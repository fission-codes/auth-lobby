<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8">
  <title>Fission Lobby IPFS Worker</title>
</head>
<body>

  <script>
      window.addEventListener("message", async event => {
        // we need to support state partitioning - https://developer.mozilla.org/en-US/docs/Web/Privacy/State_Partitioning
        // a spec meant to prevent tracking. It means that each site in a
        // browser gets its own storage bucket for caches, indexedDB,
        // sessionStorage, localStorage and more. Thus, we wouldn't be able to
        // retrieve our secrets from within an iframe on other origins.
        // To get back the storage bucket of where this html is served at,
        // we need to request it.
        if (document.hasStorageAccess && document.requestStorageAccess) {
          if (!await document.hasStorageAccess()) {
            try {
              await document.requestStorageAccess()
            } catch (e) {
              console.error(`Can't exchange secrets with auth lobby due to state partitioning (read more at https://developer.mozilla.org/en-US/docs/Web/Privacy/State_Partitioning). Try disabling privacy-protecting features for this website or somehow enable storage access for this page. If you see this issue, please tell us about it: https://fission.codes/support/.`, e)
            }
          }
        }

        // make sure the message is meant for us
        if (event.data && event.data.webnative == null) return
        const secretsKey = event.data && event.data.didExchange ?
          `encrypted-secrets-for-${event.data.didExchange}` :
          "encrypted-secrets" // backwards compatibility
        // Note: Answering the event.source means we basically
        // answer _anyone_ asking us via an iframe.
        // This is not an issue because the secrets are encrypted.
        // We don't share anything besides things prefixed as "encrypted-secrets".
        event.source.postMessage(sessionStorage.getItem(secretsKey), event.origin)

        // we don't delete the secrets, as the authenticating app might get
        // interrupted between fetching the secrets & storing them, and therefore
        // might re-request them.
      })
  </script>

  <!-- Service worker -->
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./service-worker.js")
      })
    }
  </script>

</body>
</html>
